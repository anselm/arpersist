<html>

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<link rel="stylesheet" type="text/css" href="/css/main.css">
<script src="/libs/three.js"></script>
<script src="/libs/three-gltf-loader.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="/js/chance.js"></script>
<script src="/js/Cesium.js"></script>
<script src="/js/webxr-polyfill.js"></script>
<link href="https://fonts.googleapis.com/css?family=Monofett|Roboto+Mono" rel="stylesheet">
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrirea7OVV4aKJ9Y0UAp6Nbr6-fXtr-50" type="text/javascript"></script>
</head>
<body>

<div id="arview_target">

<!-- Login page ------------------------------------------------------------------------------------------------->
<form class="page" id="login">
<center>
<br/><label>Please pick a name </label>
<br/><label>Por favor elige un nombre</label>
<br/><label>请选择一个名字</label>
<br/><label>يرجى اختيار الاسم</label>
<br/><label>בחר שם</label> 
<br/><input placeholder="Pick a handle"></input>
<br/><button> Join </button>
<!-- <br/><button id="logindone" onClick="event.preventDefault(); window.ux.action('logindone'); return 0;"> Join </button> -->
</center>
</form>

<!-- Picker ------------------------------------------------------------------------------------------------->
<form class="page" id="picker">
<center>
<br/><label>Please pick a map </label>
<div id="picker_dynamic_list"><label>...loading...</label></div>
</center>
</form>

<!-- Map  ------------------------------------------------------------------------------------------------->
<div class="page" id="maps">
this is the map page
</div>

<!-- Edit ------------------------------------------------------------------------------------------------->
<form class="page" id="editor">
<center>
<label>Edit</label>
<br/><input id="edit_name" placeholder="a name"></input>
<br/><input id="edit_art" placeholder="url to art OR words to show"></input>
<br/><label id="xedit_upright"  >   Upright </label><label class="switch">      <input id="edit_upright" type="checkbox"><span class="slider"></span></label>
<br/><label id="xedit_eyelevel" > Eye Level </label><label class="switch">      <input id="edit_eyelevel" type="checkbox"><span class="slider"></span></label>
<br/><label id="xedit_billboard"> Billboard </label><label class="switch">      <input id="edit_billboard" type="checkbox"><span class="slider"></span></label>
<br/><label id="xedit_wall"     >      Wall </label><label class="switch">      <input id="edit_wall" type="checkbox"><span class="slider"></span></label>
<br/><label id="xedit_floor"    >     Floor </label><label class="switch">      <input id="edit_floor" type="checkbox"><span class="slider"></span></label>
<br/><label id="xedit_persist"  >   Persist </label><label class="switch">      <input id="edit_persist" type="checkbox"><span class="slider"></span></label>
<br/><label id="xedit_public"   >    Public </label><label class="switch">      <input id="edit_public" type="checkbox"><span class="slider"></span></label>
<br/><label id="xedit_priority" >  Priority </label><label class="switch">      <input id="edit_priority" type="checkbox"><span class="slider"></span></label>
<br/><button id="delete" onClick="event.preventDefault();window.ux.action('delete'); return 0;"> delete</button>
<br/>
<br/><button id="nudgemap" onClick="event.preventDefault(); window.ux.action('nudgemap'); return 0;"> map</button>
<br/><button id="editdone" onClick="event.preventDefault(); window.ux.action('editdone'); return 0;"> done</button>
<br/>
<div id="edit_uuid">object uid if any</div>
<div>object location if any</div>
</center>
</form>

<!-- Augmented view ------------------------------------------------------------------------------------------------->
<div class="page" id="arview">
<button id="make" class=uxbutton onClick="window.ux.action(this.id)"> Make </button> <!-- make a fresh asset -->
<button id="edit" class=uxbutton onClick="window.ux.action(this.id)"> Edit </button> <!-- edit an asset -->
<button id="maps" class=uxbutton onClick="window.ux.action(this.id)"> Maps </button> <!-- map mode -->
<button id="save" class=uxbutton onClick="window.ux.action(this.id)"> Save </button> <!-- admin: save the map -->
<div id="description"><div id="helper"> all systems nominal </div></div>
</div>

</div>
</body>
</html>

<script type=module>

// code to manage entity state and networking for this app
import {EntityManager} from '/js/EntityManager.js'

// code for a general purpose ux framework
import {UXUrlParams,UXComponent,UXPage,UXLog} from '/js/UXComponents.js'

// code to manage user interactions for this specific app
import {UXLogin} from '/js/UXLogin.js'
import {UXPicker} from '/js/UXPicker.js'
import {UXAugmentedView} from '/js/UXAugmentedView.js'
import {UXEditor} from '/js/UXEditor.js'
import {UXMap} from '/js/UXMap.js'

// start up
window.addEventListener('DOMContentLoaded',async function() {

  // fetch browser url params
  let params = UXUrlParams()

  // hide save button if not in admin mode
  // if(!params.admin) document.getElementById("save").style.display = "none"

  // start an entity network state manager
  let entity_manager = new EntityManager(params.zone || "ZZZ",params.party || "ME",UXPage.log)

  // wait for network
  await entity_manager.entityNetworkRestart()

  // connect ux control logic to existing html
  new UXLog("helper")
  new UXLogin("login")
  let picker = new UXPicker()
  let editor = new UXEditor()
  let map = new UXMap("maps")

  new UXAugmentedView(entity_manager,"arview_target",UXPage.log,UXPage.err)

  // expose messaging to the html to allow inline onclick handlers in html for convenience
  window.ux = new UXPage()

  // make login page visible now
  UXPage.push("login")

  // connect buttons to actions
  UXPage.listen("action",(args)=> {
    UXPage.log("handling an action " + args.value)
    map.markerHelper(0)
    switch(args.value) {
      case "logindone":
        // TODO do something with name
        UXPage.push("picker")
        picker.layout("picker_dynamic_list",entity_manager.entityQuery({kind:"map"}))
        break
      case "pickerdone":
        UXPage.push("arview")
        if(args.subvalue) {
          UXPage.log("loading map " + args.subvalue )
          entity_manager.mapLoad(args.subvalue)
        }
        break
      case "maps":
        map.markerHelper( entity_manager.entityQuery.bind(entity_manager) )
        UXPage.push("maps")
        break
      case "edit":
        if( entity_manager.entityGetSelected() ) {
          editor.edit("editor",entity_manager.entityGetSelected())
          UXPage.push("editor")
        }
        break
      case "nudgemap":
        UXPage.push("maps")
        break
      case "editdone":
        {
          let entity = entity_manager.entityGetSelected()
          if(entity && map && map.latitude_longitude_updated && entity.gps) {
            UXPage.log("editor updated location of entity to lat="+map.latitude+ " lon="+map.longitude)
            entity.gps.latitude = map.latitude
            entity.gps.longitude = map.longitude
            map.latitude_longitude_updated = 0
          }
          editor.editdone(entity)
          UXPage.pop()
        }
        break
      case "make":
        entity_manager.entityAddArt()
        break
      case "delete":
        // TBD
        UXPage.err("Not written yet")
        break
      case "save":
        entity_manager.mapSave()
        break
    }
  })

})

</script>


